(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[103],{7270:function(e,t,a){Promise.resolve().then(a.bind(a,6161))},6161:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return V}});var n,r,o=a(9268),i=a(4415),s=a(1904),c=a(6006),l=a(2908),d=a(1263),u=a(6831),m=a(9153),f=a(5474),g=a(666),p=a(6653);async function h(){return await (0,f.gw)(2e3),{code:g.mI,message:"Mock",data:[{id:1,caseName:"林家花園",locationX:"24.06109876319344",locationY:"120.70354094928975",address:"413台中市霧峰區萊園路91號",description:"設伝夫求釜燃景軍業論情再馬実。軽武以",coverImgURL:"/images/mock/林家花園.jpeg",imageList:["/images/mock/林家花園.jpeg"],rotationList:["/images/mock/林家花園.jpeg"],videoList:["/images/mock/林家花園.jpeg"],operator:"admin01",operatorTime:"2023-06-19 23:30:45"}],currentPage:1,pageSize:20,totalPage:1}}async function v(e){if(g.M7)return await h();let t=new URLSearchParams(e).toString(),a=await fetch("".concat(g.FH,"/management/sites?").concat(t),{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat((0,p.L)())}});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}async function j(){return await (0,f.gw)(2e3),{code:g.mI,message:"Mock",data:{id:1,caseName:"林家花園",locationX:"24.06109876319344",locationY:"120.70354094928975",address:"413台中市霧峰區萊園路91號",description:"設伝夫求釜燃景軍業論情再馬実。軽武以",coverImgURL:"/images/mock/林家花園.jpeg",imageList:["/images/mock/林家花園.jpeg"],rotationList:["/images/mock/林家花園.jpeg"],videoList:["/images/mock/林家花園.jpeg"],operator:"admin01",operatorTime:"2023-06-19 23:30:45"}}}async function x(e){if(g.M7)return await j();let t=await fetch("".concat(g.FH,"/management/sites/").concat(e),{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat((0,p.L)())}});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));return await t.json()}async function w(){return await (0,f.gw)(2e3),{code:g.mI,message:"mock"}}async function y(e){if(g.M7)return await w();let t=await fetch("".concat(g.FH,"/management/sites/save"),{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat((0,p.L)())},body:JSON.stringify(e)});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));return await t.json()}async function b(e,t){return await (0,f.gw)(2e3),{code:g.mI,message:"mock"}}async function N(e,t){if(g.M7)return await b(e,t);let a=await fetch("".concat(g.FH,"/management/sites/").concat(e),{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat((0,p.L)())},body:JSON.stringify(t)});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}async function k(){return await (0,f.gw)(2e3),{code:g.mI,message:"mock"}}async function L(e){if(g.M7)return await k();let t=await fetch("".concat(g.FH,"/management/sites/").concat(e),{method:"DELETE",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat((0,p.L)())}});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));return await t.json()}var P=a(7007),E=a(3368),I=a(1897),T=a(2238),Z=a(6497),S=a(7053),C=a(5503),M=a(158),O=a(1301),A=a.n(O);let R=A()(()=>Promise.all([a.e(913),a.e(374),a.e(486),a.e(531),a.e(428)]).then(a.bind(a,9428)).then(e=>e.ReactPhotoSphereViewer),{loadableGenerated:{webpack:()=>[9428]},ssr:!1});async function _(e){try{let t=await x(e);if((null==t?void 0:t.code)!==g.mI){M.Z.error(null==t?void 0:t.message);return}return t.data}catch(e){}}async function z(e){let{values:t,id:a,type:n}=e;console.log({values:t,type:n});let[o,i]=t.coordinate.split(",").map(e=>e.trim());switch(n){case r.add:return await y({caseName:t.caseName,locationX:o,locationY:i,address:t.address,description:t.description,imageList:t.imageList.filter(e=>void 0!==e),videoList:t.videoList.filter(e=>void 0!==e),rotationList:t.rotationList.filter(e=>void 0!==e)});case r.update:return await N(a,{caseName:t.caseName,locationX:o,locationY:i,address:t.address,description:t.description,imageList:t.imageList.filter(e=>void 0!==e),videoList:t.videoList.filter(e=>void 0!==e),rotationList:t.rotationList.filter(e=>void 0!==e)});default:throw Error("Invalid type")}}(n=r||(r={}))[n.add=0]="add",n[n.update=1]="update";let F="landmark-form",D=(0,c.memo)(e=>{let{open:t,id:a,onClose:n,afterAdd:i,afterEdit:f}=e,p=a?r.update:r.add,h=(0,c.useRef)(),{run:v,reset:j,loading:x}=(0,s.Q)(_);(0,c.useEffect)(()=>{let e=!1;return(async()=>{if(t){var n,r;if(null===(n=h.current)||void 0===n||n.initialize({imageList:[void 0],videoList:[void 0],rotationList:[void 0]}),a){let t=await v(a);!e&&t&&(null===(r=h.current)||void 0===r||r.initialize({...t,coordinate:"".concat(t.locationX,", ").concat(t.locationY),imageList:t.imageList.length<10?t.imageList.concat(void 0):t.imageList,videoList:t.videoList.length<2?t.videoList.concat(void 0):t.videoList}))}}})(),()=>{e=!0}},[a,t,j,v]);let{run:w,loading:y}=(0,s.Q)(z),[b,N]=(0,c.useState)(!1);return(0,o.jsx)(P.Z,{open:t,title:"古蹟資訊",footer:(0,o.jsx)("div",{className:"flex justify-end",children:(0,o.jsx)(u.Z,{form:F,type:"submit",looks:m.L.dark,loading:y,children:"保存"})}),width:554,isCloseButtonShow:!0,onClose:y?void 0:n,maskClosable:!1,children:(0,o.jsx)(E.Z,{expand:!0,spinning:x,children:(0,o.jsx)(l.l0,{onSubmit:async e=>{let t=await w({values:e,id:a,type:p});(null==t?void 0:t.code)!==g.mI?M.Z.error(null==t?void 0:t.message):(M.Z.success("成功"),n(),p===r.add?i():f())},mutators:{...T.Z},render:e=>{var t;let{form:a,handleSubmit:n,values:r}=e;return h.current=a,(0,o.jsxs)("form",{id:F,onSubmit:n,children:[(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"古蹟名稱"}),(0,o.jsx)(l.gN,{name:"caseName",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(d.Z,{className:"block w-full text-sm",value:t,onChange:a})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"座標位置"}),(0,o.jsx)(l.gN,{name:"coordinate",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(d.Z,{className:"block w-full text-sm",value:t,onChange:a,placeholder:"請輸入古蹟座標位置(google map中右鍵可複製)"})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"古蹟地址"}),(0,o.jsx)(l.gN,{name:"address",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(d.Z,{className:"block w-full text-sm",value:t,onChange:a})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"古蹟描述"}),(0,o.jsx)(l.gN,{name:"description",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(I.Z,{className:"block w-full text-sm",value:t,onChange:a})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"新增圖片"}),(0,o.jsx)(Z.F2,{name:"imageList",render:e=>{let{fields:t}=e;return(0,o.jsx)("div",{className:"flex w-full flex-wrap gap-1",children:t.map((e,a)=>(0,o.jsx)(l.gN,{name:e,render:e=>{let{input:{value:n,onChange:r}}=e;return(0,o.jsx)(S.Z,{accept:"image/*",fileType:C.p.IMAGE,value:n,onChange:e=>{t.length<10&&t.push(void 0),r(e)},onRemove:()=>{t.remove(a),setTimeout(()=>{10===t.length&&t.value[9]&&t.push(void 0)})}})}},e))})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsx)("label",{className:"mb-2 block",children:"新增影片"}),(0,o.jsx)(Z.F2,{name:"videoList",render:e=>{let{fields:t}=e;return(0,o.jsx)("div",{className:"flex w-full flex-wrap gap-1",children:t.map((e,a)=>(0,o.jsx)(l.gN,{name:e,render:e=>{let{input:{value:n,onChange:r}}=e;return(0,o.jsx)(S.Z,{accept:"video/*",fileType:C.p.VIDEO,value:n,onChange:e=>{t.length<2&&t.push(void 0),r(e)},onRemove:()=>{t.remove(a),setTimeout(()=>{2===t.length&&t.value[1]&&t.push(void 0)})}})}},e))})}})]}),(0,o.jsxs)("div",{className:"m-2",children:[(0,o.jsxs)("div",{className:"mb-2 flex items-center gap-1",children:[(0,o.jsx)("label",{children:"環景照片"}),(0,o.jsx)(u.Z,{looks:m.L.secondary,type:"button",onClick:()=>{r.rotationList[0]&&N(!0)},children:"預覽"}),(0,o.jsx)(P.Z,{open:b,onClose:()=>{N(!1)},children:(0,o.jsx)(R,{height:"400px",width:"500px",src:null===(t=r.rotationList)||void 0===t?void 0:t[0]})})]}),(0,o.jsx)(Z.F2,{name:"rotationList",render:e=>{let{fields:t}=e;return t.map((e,a)=>(0,o.jsx)(l.gN,{name:e,render:e=>{let{input:{value:n,onChange:r}}=e;return(0,o.jsx)(S.Z,{accept:"image/*",fileType:C.p.PANORAMA,value:n,onChange:r,onRemove:()=>{t.remove(a),setTimeout(()=>{1===t.length&&t.push(void 0)})}})}},e))}})]})]})}})})})});D.displayName="FormModal";var H=a(7454);async function B(e,t){console.log(e,t);try{let a=await v((0,f.o2)({id:null==e?void 0:e.id,name:null==e?void 0:e.name,pageNum:null==t?void 0:t.page,pageSize:null==t?void 0:t.pageSize}));return(null==a?void 0:a.code)!==g.mI&&M.Z.error(null==a?void 0:a.message),a}catch(e){return}}let U=(0,c.memo)(()=>{let e=(0,c.useRef)(),{run:t,refresh:a,data:n,loading:r}=(0,s.Q)(B),p=(0,c.useRef)(t),[h,v]=(0,c.useState)({page:1,pageSize:20,totalPage:1}),j=(0,c.useRef)(h);(0,c.useEffect)(()=>{(async()=>{let e=await p.current(void 0,j.current);(null==e?void 0:e.code)===g.mI&&v({page:e.currentPage,pageSize:e.pageSize,totalPage:e.totalPage})})()},[]);let{openModal:x,formModalProps:w}=function(){let[e,t]=(0,c.useState)({open:!1}),a=(0,c.useCallback)(e=>{t({id:e,open:!0})},[]),n=(0,c.useCallback)(()=>{t({open:!1})},[]);return(0,c.useMemo)(()=>({openModal:a,formModalProps:{...e,onClose:n}}),[a,e,n])}(),y=(0,c.useMemo)(()=>[{title:"ID",dataIndex:"id"},{title:"古蹟名稱",dataIndex:"caseName"},{title:"座標位置",render:(e,t)=>"".concat(t.locationX,", ").concat(t.locationY)},{title:"古蹟地址",dataIndex:"address"},{title:"古蹟描述",dataIndex:"description"},{title:"封面照",dataIndex:"coverImgURL",render:e=>(0,o.jsx)(H.Z,{className:"h-24 w-24 min-w-24 object-cover",src:e,width:100,height:100,alt:"封面照"})},{title:"操作者",dataIndex:"operator"},{title:"操作時間",dataIndex:"operatorTime",render:e=>(0,f.rn)(e)},{title:"操作",render:(e,t)=>(0,o.jsxs)("div",{className:"flex gap-2",children:[(0,o.jsx)(u.Z,{looks:m.L.green,onClick:()=>{x(t.id)},children:"編輯"}),(0,o.jsx)(u.Z,{looks:m.L.danger,onClick:()=>{P.Z.confirm({content:(0,o.jsx)("p",{children:"是否確認刪除？"}),onOk:async()=>{let e=await L(t.id);if((null==e?void 0:e.code)!==g.mI)throw M.Z.error(null==e?void 0:e.message),Error("delete failed");M.Z.success("成功"),a()},okButtonProps:{looks:m.L.danger}})},children:"刪除"})]})}],[x,a]);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsx)(l.l0,{onSubmit:async e=>{let a=await t(e,{page:1,pageSize:h.pageSize});(null==a?void 0:a.code)===g.mI?v({page:a.currentPage,pageSize:a.pageSize,totalPage:a.totalPage}):v(e=>({...e,page:1,totalPage:1}))},render:t=>{let{form:a,handleSubmit:n}=t;return e.current=a,(0,o.jsxs)("form",{className:"flex gap-2",onSubmit:n,children:[(0,o.jsx)(l.gN,{name:"id",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(d.Z,{value:t,onChange:a,placeholder:"請輸入ID"})}}),(0,o.jsx)(l.gN,{name:"name",render:e=>{let{input:{value:t,onChange:a}}=e;return(0,o.jsx)(d.Z,{value:t,onChange:a,placeholder:"請輸入古蹟名稱"})}}),(0,o.jsx)("button",{className:"hidden",type:"submit"})]})}}),(0,o.jsx)(u.Z,{looks:m.L.dark,onClick:()=>{x()},children:"新增古蹟"})]}),(0,o.jsx)(i.Z,{className:"mt-6",columns:y,dataSource:null==n?void 0:n.data,loading:r,pagination:{...h,onChange:(a,n)=>{var r;v(e=>({...e,page:a,pageSize:n})),t(null===(r=e.current)||void 0===r?void 0:r.getState(),{page:a,pageSize:n})}}}),(0,o.jsx)(D,{...w,afterAdd:t,afterEdit:a})]})});U.displayName="LandMarkPage";var V=U},7454:function(e,t,a){"use strict";var n=a(9268),r=a(6394),o=a.n(r),i=a(6006),s=a(8582);let c=(0,i.memo)((0,i.forwardRef)((e,t)=>{let{src:a,...r}=e;return(0,n.jsx)(o(),{...r,ref:t,unoptimized:!0,src:"string"==typeof a?(0,s.A0)(a):a})}));c.displayName="CustomImage",t.Z=c},1897:function(e,t,a){"use strict";var n=a(9268),r=a(8683),o=a.n(r),i=a(6006);let s=(0,i.memo)((0,i.forwardRef)((e,t)=>{let{className:a,value:r,onChange:i}=e;return(0,n.jsx)("textarea",{className:o()("rounded border border-solid border-gray-300 p-1",a),value:r,onChange:e=>{null==i||i(e.target.value)},ref:t})}));t.Z=s},7053:function(e,t,a){"use strict";a.d(t,{Z:function(){return N}});var n=a(9268),r=a(6006),o=a(7454),i=a(1904),s=a(3368),c=a(5503),l=a(5474),d=a(666),u=a(6653);async function m(){return await (0,l.gw)(2e3),{code:d.mI,message:"Mock",data:"/images/mock/朝日夫婦.jpeg"}}async function f(e){if(d.M7)return await m();let t=new FormData;t.append("file",e);let a=await fetch("".concat(d.FH,"/file/upload/image"),{method:"POST",mode:"cors",headers:{Authorization:"Bearer ".concat((0,u.L)())},body:t});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}async function g(){return await (0,l.gw)(2e3),{code:d.mI,message:"Mock",data:"/videos/mock/朝日夫婦.mp4"}}async function p(e){if(d.M7)return await g();let t=new FormData;t.append("file",e);let a=await fetch("".concat(d.FH,"/file/upload/video"),{method:"POST",mode:"cors",headers:{Authorization:"Bearer ".concat((0,u.L)())},body:t});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}async function h(){return await (0,l.gw)(2e3),{code:d.mI,message:"Mock",data:"/panoramas/mock/朝日夫婦.jpeg"}}async function v(e){if(d.M7)return await h();let t=new FormData;t.append("file",e);let a=await fetch("".concat(d.FH,"/file/upload/panorama"),{method:"POST",mode:"cors",headers:{Authorization:"Bearer ".concat((0,u.L)())},body:t});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}var j=a(158);let x=(0,r.memo)(e=>{let{className:t,url:a}=e,[i,c]=(0,r.useState)(""),l=(0,r.useRef)(null),d=(0,r.useRef)(null);return(0,r.useEffect)(()=>{let e=l.current,t=d.current,a=async()=>{try{e.currentTime=0,await e.play(),e.removeEventListener("canplay",a),e.pause(),t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0,t.width,t.height),c(t.toDataURL())}catch(e){console.log(e)}};return e.addEventListener("canplay",a),()=>{e.removeEventListener("canplay",a)}},[]),(0,n.jsxs)("div",{children:[(0,n.jsx)("video",{className:"hidden",src:a,ref:l,crossOrigin:"anonymous"}),(0,n.jsx)("canvas",{className:"hidden",ref:d}),(0,n.jsx)(s.Z,{spinning:!!a&&!i,children:(0,n.jsx)(o.Z,{className:t,src:i||"/images/mock/add-image.png",width:100,height:100,alt:"Video Thumbnail"})})]})});x.displayName="VideoThumbnail";var w=a(8683),y=a.n(w);let b=(0,r.memo)(e=>{let{className:t,accept:a,fileType:l,value:u,onChange:m,onRemove:g}=e;console.log({value:u});let{loading:h,run:w}=(0,i.Q)(async e=>{try{switch(l){case c.p.IMAGE:{let t=await f(e);if(t.code===d.mI)return j.Z.success("成功"),null==m||m(t.data),t.data;j.Z.error(t.message);break}case c.p.VIDEO:{let t=await p(e);if(t.code===d.mI)return j.Z.success("成功"),null==m||m(t.data),t.data;j.Z.error(t.message);break}case c.p.PANORAMA:{let t=await v(e);if(t.code===d.mI)return j.Z.success("成功"),null==m||m(t.data),t.data;j.Z.error(t.message)}}}catch(e){j.Z.error(null==e?void 0:e.message)}}),b=(0,r.useRef)(null),[N,k]=(0,r.useState)(!1);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("input",{className:"hidden",type:"file",accept:a,ref:b,onClick:()=>{b.current.value=""},onChange:async e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];a&&await w(a)}}),(0,n.jsx)(s.Z,{spinning:h,children:(0,n.jsxs)("div",{className:"relative inline-block",onMouseEnter:()=>{k(!0)},onMouseLeave:()=>{k(!1)},onClick:()=>{u&&(null==g||g())},children:[l===c.p.VIDEO&&u?(0,n.jsx)(x,{className:y()("h-24 w-24 cursor-pointer object-cover",{"opacity-30":N}),url:u}):(0,n.jsx)(o.Z,{className:y()("h-24 w-24 cursor-pointer object-cover",{"opacity-30":u&&N}),src:u||"/images/mock/add-image.png",width:100,height:100,alt:"add",onClick:()=>{u||b.current.click()}}),u&&N&&(0,n.jsx)(o.Z,{className:"absolute inset-0 m-auto opacity-50",src:"/images/trash-solid.svg",width:14,height:16,alt:"delete"})]})})]})});b.displayName="Upload";var N=b},7613:function(e){"use strict";e.exports={output:"export",basePath:"/historic-site-portal-demo-test"}},1301:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return i}});let n=a(6927);a(6006);let r=n._(a(1937));function o(e){return{default:(null==e?void 0:e.default)||e}}function i(e,t){let a=r.default,n={loading:e=>{let{error:t,isLoading:a,pastDelay:n}=e;return null}};"function"==typeof e&&(n.loader=e),Object.assign(n,t);let i=n.loader;return a({...n,loader:()=>null!=i?i().then(o):Promise.resolve(o(()=>null))})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},7069:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var a in t)Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}(t,{suspense:function(){return r},NoSSR:function(){return o}}),a(6927),a(6006);let n=a(4722);function r(){let e=Error(n.NEXT_DYNAMIC_NO_SSR_CODE);throw e.digest=n.NEXT_DYNAMIC_NO_SSR_CODE,e}function o(e){let{children:t}=e;return t}},1937:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return i}});let n=a(6927),r=n._(a(6006)),o=a(7069),i=function(e){let t=Object.assign({loader:null,loading:null,ssr:!0},e);function a(e){let a=t.loading,n=r.default.createElement(a,{isLoading:!0,pastDelay:!0,error:null}),i=t.ssr?r.default.Fragment:o.NoSSR,s=t.lazy;return r.default.createElement(r.default.Suspense,{fallback:n},r.default.createElement(i,null,r.default.createElement(s,e)))}return t.lazy=r.default.lazy(t.loader),a.displayName="LoadableComponent",a}},5503:function(e,t,a){"use strict";var n,r;a.d(t,{p:function(){return n}}),(r=n||(n={}))[r.VIDEO=0]="VIDEO",r[r.PANORAMA=1]="PANORAMA",r[r.IMAGE=2]="IMAGE"},8582:function(e,t,a){"use strict";a.d(t,{$x:function(){return c},A0:function(){return d},Qv:function(){return l},_b:function(){return u},qz:function(){return s}});var n=a(7613),r=a.n(n),o=a(3034),i=a(6008);let s="redirect",c="/member",l="/login";function d(e){return e.startsWith("/")&&r().basePath?"".concat(r().basePath).concat(e):e}function u(e,t){(0,i.redirect)("".concat(l).concat(e===d("/")?"":"?".concat(s,"=").concat(encodeURIComponent("".concat(e,"?").concat(t.toString())))),o.RedirectType.replace)}}},function(e){e.O(0,[550,263,656,320,253,488,744],function(){return e(e.s=7270)}),_N_E=e.O()}]);